<!DOCTYPE html>
<html>

<head>
  <title>Attendance</title>
 <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />

  <script src="data.js"></script>
  <script src="html2pdf.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
  crossorigin="anonymous"></script>
  <script>
        $(function(){
        data = localStorage.getItem("data");
        if(data){
            response = JSON.parse(data);
        }
        run();
        $("#totalAbsent").html(response.filter((item) => item.Status === 'Absent').length);
        $("#totalPresent").html(response.filter((item) => item.Status === 'Present').length);
    });
  </script>
  <style>
    #table{
        min-width: 300px;
    }
    @media screen and (max-width: 390px) {
        tr,span{
             font-size:13px;
             transition: font-size .9s;
        }
    }

  </style>
</head>

<body>
  <div class="container p-2">
    <div class="d-flex align-items-center  p-1 flex-column gap-3">
        <input type="date" name="" id="date" class="form-control" />
        <select name="courses" id="course" class="form-control">
          <option value="Software Engineering">SE</option>
          <option value="Artificial Intelligence">AI</option>
          <option value="Big Data Analysis">BDA</option>
          <option value="Information Security">IS</option>
          <option value="Professional Practice in Software Development">PPSD</option>
        </select>
    </div>
    <div class="container d-inline-flex justify-content-evenly gap-3" style="margin-top: 1%">
      <button id="download-button" class="btn btn-outline-dark col-6" onclick="pdf()">
        Download PDF
      </button>
      <button id="download-button-csv" class="btn btn-outline-secondary col-6" onclick="csv()">
        Download CSV
      </button>

    </div>
  </div>
   <table class="table table-striped table-hover" style="user-select:none" id="table">
      <thead>
        <tr>
          <th class="name" onclick="statusClick()">Registration Number</th>
          <th class="name" onclick="statusClick()">Name</th>
        </tr>
      </thead>
    </table>
    <div class="d-flex align-items-center p-2 flex-column gap-3">
        <div class="container d-inline-flex justify-content-evenly gap-3" style="margin-top: 1%">
            <span  id="totalPresent" class="btn btn-success col-6">
              0
            </span>
            <span id="totalAbsent" class="btn btn-danger col-6" >
              41
            </span>
          </div> 
        </div>     
  <footer class="bg-dark text-center text-white">
    <!-- Copyright -->
    <div class="text-center p-3 " style="background-color: rgba(0, 0, 0, 0.2);">
      Â© <span><script>document.write( new Date().getUTCFullYear() );</script> Copyright:
        &#128513; Itna to banta ha bro &#x1F609;</span>
    </div>
    <!-- Copyright -->
  </footer>

  <script type="text/javascript">

     function getDate(){
        return $("#date").val() ? $("#date").val() : new Date().toLocaleDateString('en-GB').replaceAll('/','-')
     }
    function csv(){
        // var html = document.querySelector("table").outerHTML;
      localStorage.setItem("table", JSON.stringify(response));  
      htmlToCSV("Section-B-" + getDate() + ".csv",response);
    }


    function htmlToCSV(filename,response) {
        console.log(response)
      var data = [];
      var rows = document.querySelectorAll("table tr");
      data.push(",,,,,,,Subject:," + document.getElementById("course").value);
      data.push(",,,,,,,Date:," + getDate());
      data.push(",,,,,,,Total Present:," + document.getElementById("totalPresent").innerText);      
      data.push(",,,,,,,Total Absent:," + document.getElementById("totalAbsent").innerText);      
        for (var i = 0; i < response.length; i++) {
            var row = [];
            row.push(response[i].RegistrationNumber + "," + response[i].Name + "," + response[i].Status[0]);
            data.push(row.join(","));
        }
      downloadCSVFile(data.join("\n"), filename);
    }

    function downloadCSVFile(csv, filename) {
      var csv_file, download_link;

      csv_file = new Blob([csv], { type: "text/csv" });

      download_link = document.createElement("a");

      download_link.download = filename;

      download_link.href = window.URL.createObjectURL(csv_file);

      download_link.style.display = "none";

      document.body.appendChild(download_link);

      download_link.click();
    }
    function generateTable() {

       let aCount =  $("#totalAbsent").text();
       let pCount =$("#totalPresent").text();
      let rowData = "<center><h2>" + $("#course").val() + "</h2></br><h2>" + getDate() + "</h2></center>" + "<div class=\"d-inline-flex flex-row justify-content-between\"><h5>Total Students: <em style=\"color:Blue;\">" + response.length + "</em></h5><h5 style=\"margin-left:25px\">Present Students: <em style=\"color:lightBlue;\">" + pCount + "</em></h5><h5 style=\"margin-left:25px\">Absent Students: <em style=\"color:red;\">" + aCount + "</em></h5></div>" +
        "<table class=\"table  \" id=\"table\"> <thead class=\"thead-dark\"> <tr><th scope=\"col\" class=\"name\">Registration Number</th><th scope=\"col\" class=\"name\">Name</th></tr></thead><tbody>";
      for (let i = 0; i < response.length; i++) {
        if (response[i].Status === "Present") {
          rowData +=
            '<tr><td class="name">' +
            response[i].RegistrationNumber +
            '</td><td class="name">' +
            response[i].Name +
            "</td></tr>";
        }
      }
      rowData += "</tbody></table>"
      return rowData;
    }
    
    function run() {
        
     let table = document.getElementById("table");
      let rowData = "";
       for (let i = 0; i < response.length; i++) {
        status =  response[i].Status === "Present" ? '<input type="checkbox" class="form-check-input rounded-circle bg-dark" checked disabled id="status' :
            '<input type="checkbox" class="form-check-input rounded-circle bg-dark" style="display:none;" id="status'
          rowData +=
            '<tr><td class="name d-flex justify-content-between" onclick="isStatusChecked('+i+')">' +
            response[i].RegistrationNumber + status +
            i +
            '"/>' +
            '</td><td class="name " onclick="isStatusChecked('+i+')"> ' +
            response[i].Name 
            "</td></tr>";
        }
      table.innerHTML +=rowData;
    }
    function isStatusChecked(i) {

     if(response[i].Status === "Absent"){
            response[i].Status = "Present";
            $("#status" + i).show() ;
            $("#status" + i).prop("checked",true);
            $("#status" + i).attr('disabled',true);
        }
        else{
            response[i].Status = "Absent";
            $("#status" + i).hide() ; 
        }  
        $("#totalAbsent").html(response.filter((item) => item.Status === 'Absent').length);
        $("#totalPresent").html(response.filter((item) => item.Status === 'Present').length);
    }
    function statusClick() {
        if(response.filter((item) => item.Status === 'Present').length === 41){
            
            for (let i = 0; i < response.length; i++) {
            response[i].Status = "Absent";
            $("#status" + i).hide() ;
            $("#status" + i).prop("checked",false);
            $("#status" + i).attr('disabled',true);
          }
        }
        else{
                  for (let i = 0; i < response.length; i++) {
            response[i].Status = "Present";
            $("#status" + i).show() ;
            $("#status" + i).prop("checked",true);
            $("#status" + i).attr('disabled',true);
          }
  
        }

        $("#totalAbsent").html(response.filter((item) => item.Status === 'Absent').length);
        $("#totalPresent").html(response.filter((item) => item.Status === 'Present').length);
    }
    function pdf() {
      localStorage.setItem("data", JSON.stringify(response));  
      const element = generateTable();
      html2pdf().from(element).save("Section-B-" + getDate() + ".pdf");
    }
  </script>

</body>

</html>
